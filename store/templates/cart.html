{% extends 'base.html' %}

{% block body %}
<div class="container py-5 mt-4">
    <h2 class="fw-bold mb-4">My Cart</h2>
    
    <div class="row g-4">
        <div class="col-lg-8">
            <div id="cart-items-container">
                </div>
            
            <div id="empty-cart-msg" style="display: none;" class="text-center py-5 shadow-sm bg-white rounded-4">
                <i class="bi bi-cart-x display-1 text-muted"></i>
                <h4 class="mt-3 fw-bold">Your cart is empty</h4>
                <p class="text-muted">Looks like you haven't added anything yet.</p>
                <a href="{% url 'home' %}" class="btn btn-orange px-4 rounded-3">Start Shopping</a>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 p-4 sticky-top" style="top: 100px;">
                <h5 class="fw-bold mb-3">Order Summary</h5>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Item Total</span>
                    <span id="summary-total">₹0</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span class="text-muted">Delivery Fee</span>
                    <span class="text-success">FREE</span>
                </div>
                <hr>
                <div class="d-flex justify-content-between mb-4">
                    <h5 class="fw-bold">Grand Total</h5>
                    <h5 class="fw-bold text-orange" id="summary-grand-total">₹0</h5>
                </div>
                <a href="{% url 'checkout' %}" class="btn btn-orange w-100 btn-lg rounded-3 fw-bold shadow-sm">Proceed to Checkout</a>
            </div>
        </div>
    </div>
</div>

<style>
    .cart-item-card {
        background: white;
        border: 1px solid #eef0f5;
        border-radius: 16px;
        padding: 15px;
        margin-bottom: 15px;
        transition: 0.2s;
    }
    .cart-item-card:hover { border-color: #fc8019; }
    .qty-btn {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        border: 1px solid #d4d5d9;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
    }
    .text-orange { color: #fc8019; }
    .btn-orange { background-color: #fc8019; color: white; border: none; }
    .btn-orange:hover { background-color: #e36a05; color: white; }
</style>

<script>
    function loadCartPage() {
        let cart = JSON.parse(localStorage.getItem('grocify_cart')) || [];
        const container = document.getElementById('cart-items-container');
        const emptyMsg = document.getElementById('empty-cart-msg');
        
        if (cart.length === 0) {
            container.innerHTML = "";
            emptyMsg.style.display = 'block';
            updateSummary(0);
            return;
        }

        emptyMsg.style.display = 'none';
        let html = "";
        let total = 0;

        cart.forEach((item, index) => {
            const itemTotal = item.price * item.quantity;
            total += itemTotal;
            html += `
                <div class="cart-item-card d-flex align-items-center gap-3 shadow-sm">
                    <div class="flex-grow-1">
                        <h6 class="fw-bold mb-0">${item.name}</h6>
                        <small class="text-muted">₹${item.price} per unit</small>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center border rounded-3 p-1">
                            <button class="qty-btn" onclick="changeQty(${index}, -1)">-</button>
                            <span class="px-3 fw-bold">${item.quantity}</span>
                            <button class="qty-btn" onclick="changeQty(${index}, 1)">+</button>
                        </div>
                        <div class="fw-bold text-end" style="min-width: 80px;">₹${itemTotal}</div>
                        <button class="btn btn-sm text-danger" onclick="removeItem(${index})"><i class="bi bi-trash"></i></button>
                    </div>
                </div>
            `;
        });

        container.innerHTML = html;
        updateSummary(total);
    }

    function changeQty(index, delta) {
        let cart = JSON.parse(localStorage.getItem('grocify_cart'));
        cart[index].quantity += delta;
        
        if (cart[index].quantity < 1) {
            cart.splice(index, 1);
        }
        
        localStorage.setItem('grocify_cart', JSON.stringify(cart));
        loadCartPage();
        if (typeof updateCartBadge === "function") updateCartBadge(); // Update navbar
    }

    function removeItem(index) {
        let cart = JSON.parse(localStorage.getItem('grocify_cart'));
        cart.splice(index, 1);
        localStorage.setItem('grocify_cart', JSON.stringify(cart));
        loadCartPage();
        if (typeof updateCartBadge === "function") updateCartBadge();
    }

    function updateSummary(total) {
        document.getElementById('summary-total').innerText = `₹${total}`;
        document.getElementById('summary-grand-total').innerText = `₹${total}`;
    }

    document.addEventListener('DOMContentLoaded', loadCartPage);
</script>
{% endblock %}