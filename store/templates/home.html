{% extends 'base.html' %}

{% block body %}
<div class="container py-4">
    
    <div class="banner-section mb-5">
        <div class="row g-4">
            <div class="col-lg-8">
                <div id="mainBannerCarousel" class="carousel slide rounded-4 overflow-hidden shadow-sm" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        {% for banner in main_banners %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}" data-bs-interval="3000">
                            <div class="banner-card position-relative p-5 d-flex align-items-center justify-content-between text-white" 
                                 style="background: linear-gradient(135deg, #ff9933 0%, #fc8019 100%); height: 300px;">
                                <div class="banner-content z-2">
                                    <h1 class="display-5 fw-bold mb-2">{{ banner.title|linebreaksbr }}</h1>
                                    <p class="mb-4 fs-5 opacity-90">{{ banner.subtitle }}</p>
                                    <a href="{{ banner.link }}" class="btn btn-light text-orange fw-bold rounded-pill px-5 py-2 shadow-sm banner-btn">Shop Now</a>
                                </div>
                                <img src="{{ banner.image.url }}" class="banner-img position-absolute bottom-0 end-0" style="height: 95%; object-fit: contain;">
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            <div class="col-lg-4 d-none d-lg-block">
                <div class="banner-card sub-banner position-relative overflow-hidden rounded-4 p-4 d-flex flex-column justify-content-center shadow-sm" style="height: 300px; background-color: #000;">
                    <div class="z-2 text-white">
                        {% if side_banner %}
                            <h3 class="fw-bold mb-2">{{ side_banner.title|linebreaksbr }}</h3>
                            <a href="{{ side_banner.link }}" class="btn btn-orange rounded-pill px-4 fw-bold text-white">View Details</a>
                        {% endif %}
                    </div>
                    {% if side_banner and side_banner.image %}
                        <img src="{{ side_banner.image.url }}" class="banner-img position-absolute top-0 start-0" style="height: 100%; width: 100%; object-fit: cover; opacity: 0.7;">
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0 text-dark">Category</h2>
    </div>
    <div class="scrolling-wrapper d-flex gap-4 pb-4 mb-5">
        {% for category in categories_with_products %}
        <a href="{% url 'category_products' category.id %}" class="text-decoration-none">
            <div class="text-center" style="min-width: 130px;">
                <div class="category-circle-md shadow-sm mb-2">
                    <img src="{{ category.image.url }}" class="category-img-fit">
                </div>
                <h6 class="fw-bold text-dark small">{{ category.name }}</h6>
            </div>
        </a>
        {% endfor %}
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-bold m-0 text-dark">Best Selling Products</h2>
    </div>
    <div class="scrolling-wrapper d-flex gap-3 pb-4 mb-5">
        {% for product in hot_deals %}
        <div class="uniform-card shadow-sm">
            <div class="uniform-img-container">
                <img src="{{ product.image.url }}" class="uniform-prod-img">
                {% if product.mrp > product.selling_price %}
                <span class="badge-sale">{{ product.discount_percentage }}% OFF</span>
                {% endif %}
            </div>
            <div class="p-3">
                <h6 class="fw-bold text-dark text-truncate mb-1 small">{{ product.name }}</h6>
                <p class="text-muted extra-small mb-2">{{ product.weight|default:"1 unit" }}</p>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <div class="d-flex flex-column">
                        <span class="fw-bold text-dark">₹{{ product.selling_price }}</span>
                        {% if product.mrp > product.selling_price %}
                        <span class="text-muted text-decoration-line-through extra-small">₹{{ product.mrp }}</span>
                        {% endif %}
                    </div>
                    <button class="add-btn-round add-to-cart" 
                            data-id="{{ product.id }}" 
                            data-name="{{ product.name }}" 
                            data-price="{{ product.selling_price }}">
                        <i class="bi bi-plus-lg"></i>
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% for category in categories_with_products %}
        {% if category.name|lower == "fruits" or category.name|lower == "vegetables" %}
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="fw-bold m-0">{{ category.name }}</h3>
        </div>
        <div class="scrolling-wrapper d-flex gap-3 pb-4 mb-5">
            {% for product in category.product_set.all %}
            <div class="uniform-card shadow-sm">
                <div class="uniform-img-container">
                    <img src="{{ product.image.url }}" class="uniform-prod-img">
                    {% if product.mrp > product.selling_price %}
                    <span class="badge-sale">{{ product.discount_percentage }}% OFF</span>
                    {% endif %}
                </div>
                <div class="p-3">
                    <p class="fw-bold text-dark text-truncate m-0 small">{{ product.name }}</p>
                    <p class="text-muted extra-small mb-2">{{ product.weight|default:"1 unit" }}</p>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <div class="d-flex flex-column">
                            <span class="fw-bold text-dark">₹{{ product.selling_price }}</span>
                            {% if product.mrp > product.selling_price %}
                            <span class="text-muted text-decoration-line-through extra-small">₹{{ product.mrp }}</span>
                            {% endif %}
                        </div>
                        <div class="add-btn-round add-to-cart" 
                             data-id="{{ product.id }}" 
                             data-name="{{ product.name }}" 
                             data-price="{{ product.selling_price }}">
                            <i class="bi bi-plus-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endfor %}
</div>

<style>
    :root { --brand-orange: #fc8019; }

    .scrolling-wrapper { 
        overflow-x: auto; 
        scrollbar-width: none; 
        -ms-overflow-style: none; 
        display: flex;
    }
    .scrolling-wrapper::-webkit-scrollbar { display: none; }

    .category-circle-md { width: 130px; height: 130px; border-radius: 50%; overflow: hidden; margin: 0 auto; background: #fff; border: 2px solid #eee; }
    .category-img-fit { width: 100%; height: 100%; object-fit: cover; }

    .uniform-card {
        min-width: 180px; 
        max-width: 180px; 
        background: #fff;
        border-radius: 16px; 
        border: 1px solid #f2f2f2; 
        overflow: hidden;
        flex-shrink: 0;
        transition: transform 0.2s;
    }
    .uniform-card:hover { transform: translateY(-5px); }

    .uniform-img-container {
        width: 100%; 
        height: 140px; 
        background: #f8f9fa;
        display: flex; 
        align-items: center; 
        justify-content: center;
        padding: 15px; 
        position: relative;
    }
    .uniform-prod-img { max-width: 100%; max-height: 100%; object-fit: contain; }

    .badge-sale { 
        position: absolute; 
        top: 0; 
        left: 0; 
        background: #2563eb; 
        color: #fff; 
        font-size: 10px; 
        padding: 4px 8px; 
        border-bottom-right-radius: 12px; 
        font-weight: 800; 
    }

    .add-btn-round { width: 34px; height: 34px; background: white; border: 1px solid var(--brand-orange); color: var(--brand-orange); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
    .add-btn-round:hover { background: var(--brand-orange); color: white; }

    .extra-small { font-size: 11px; }
    .text-orange { color: var(--brand-orange) !important; }
</style>

<script>
    document.addEventListener('click', function(e) {
        const btn = e.target.closest('.add-to-cart');
        if (btn) {
            let cart = JSON.parse(localStorage.getItem('grocify_cart')) || [];
            const productId = btn.dataset.id;
            const existing = cart.find(item => item.id === productId);
            if (existing) existing.quantity += 1;
            else cart.push({ id: productId, name: btn.dataset.name, price: parseFloat(btn.dataset.price), quantity: 1 });
            localStorage.setItem('grocify_cart', JSON.stringify(cart));
            if (typeof updateNavbarBadge === "function") updateNavbarBadge();
            btn.style.transform = "scale(0.9)";
            setTimeout(() => btn.style.transform = "", 100);
        }
    });
</script>
{% endblock %}